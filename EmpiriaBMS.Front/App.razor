@using Microsoft.Extensions.Configuration
@using Microsoft.AspNetCore.Hosting
@using Microsoft.Extensions.Hosting
@using EmpiriaBMS.Front.Components.Admin
@using EmpiriaBMS.Front.Services
@using EmpiriaBMS.Front.Horizontal
@using System.Net.Http.Headers

@inject TeamsFx teamsfx
@inject TeamsUserCredential teamsUserCredential
@inject MicrosoftTeams MicrosoftTeams
@inject IWebHostEnvironment HostEnvironment
@inject IConfiguration Configuration
@inject NavigationManager NavigationManager
@inject IDataProvider DataProvider
@inject IMapper Mapper
@inject AuthorizeServices authorizeServices
@inject HttpClient HttpClient

@if(isLoading)
{
    <div style="display: flex; justify-content: center; align-items: center; min-height: 100vh;">
        <FilterProgressRing FilterLoading="@isLoading"/>
    </div>
}
else
{
    @if (SeeDashboard)
    {
        <FluentDesignSystemProvider AccentBaseColor="#6264A7">
            <Router AppAssembly="@typeof(Program).Assembly" PreferExactMatches="@true">
                <Found Context="routeData">
                    <RouteView RouteData="@routeData" DefaultLayout="@typeof(MainLayout)" />
                </Found>
                <NotFound>
                    <LayoutView Layout="@typeof(MainLayout)">
                        <p>Sorry, there's nothing at this address.</p>
                    </LayoutView>
                </NotFound>
            </Router>
        </FluentDesignSystemProvider>
    }

    <!-- Remove This -->
    <select class="form-select" @onchange="RoleSelectionChanged"
            style="position:fixed !important; bottom:0px !important; width: 200px; left: 10px;">
        @foreach (var role in _allRoles)
        {
            @if (@role.Name.Equals(authorizeServices.DefaultRoleName))
            {
                <option value="@role.Id" selected>@role.Name</option>
            }
            else
            {
                <option value="@role.Id">@role.Name</option>
            }
        }
    </select>
}


@code {
    bool _runInTeams = false;
    bool isLoading = true;

    #region Authorization Properties
    public bool SeeAdmin
    {
        get
        {
            return authorizeServices.PermissionOrds.Contains(7);
        }
    }
    public bool SeeDashboard
    {
        get
        {
            return authorizeServices.PermissionOrds.Contains(4);
        }
    }
    #endregion

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        if (firstRender)
        {
            _runInTeams = await MicrosoftTeams.IsInTeams();
            await GetAllRoles(); // TODO: Remove This
            authorizeServices.CallBackOnAuthorize += _afterAuthCallBack;
            await authorizeServices.Authorize(runInTeams: _runInTeams);
        }
    }

    private async Task _afterAuthCallBack()
    {
        isLoading = false;
        StateHasChanged();
        await _navigateToAdminArea(authorizeServices.LogedUserObjectId);
    }

    private async Task _navigateToAdminArea(string objectId)
    {
        await MicrosoftTeams.NavigateToAdmin("/Admin/Projects/Table", objectId);
    }

    private string GetEnvironmentName()
    {
        return HostEnvironment.IsDevelopment() ? "local environment" : "Azure environment";
    }

    // TODO: Remove This
    // Engineer, Designer, Project Manager, CTO, COO, Guest, CEO, Customer, Admin
    private ICollection<RoleVM> _allRoles = new List<RoleVM>();

    private async Task RoleSelectionChanged(ChangeEventArgs e)
    {
        isLoading = true;
        var selectRoleId = Convert.ToInt32(e.Value);
        await authorizeServices.Authorize(selectRoleId, _runInTeams);
        authorizeServices.DefaultRoleName = _allRoles.FirstOrDefault(r => r.Id == selectRoleId).Name;
        isLoading = false;
        isLoading = false;
        StateHasChanged();
    }

    private async Task GetAllRoles()
    {
        var rolesDtos = await DataProvider.Roles.GetAll();
        var roles = Mapper.Map<List<RoleVM>>(rolesDtos);
        _allRoles.Clear();
        roles.ForEach(_allRoles.Add);
    }
}

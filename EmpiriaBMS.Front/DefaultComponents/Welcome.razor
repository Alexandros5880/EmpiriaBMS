@page "/"
@page "/welcome"

@using Microsoft.Extensions.Configuration
@using Microsoft.AspNetCore.Hosting
@using Microsoft.Extensions.Hosting

@inject TeamsFx teamsfx
@inject TeamsUserCredential teamsUserCredential
@inject MicrosoftTeams MicrosoftTeams
@inject IWebHostEnvironment HostEnvironment
@inject IConfiguration Configuration
@inject NavigationManager MyNavigationManager
@inject IDataProvider DataProvider
@inject IMapper Mapper


@if(isLoading)
{
    <div style="display: flex; justify-content: center; align-items: center; min-height: 100vh;">
		<FluentProgressRing/>
	</div>
}
else
{
    <Projects LogedUser="@_logedUser" LogesUserHours="@_logesUserHours" LoggedUserRoles="@_loggedUserRoles"/>
}

@code {
    bool _runInTeams = false;
    bool _authenticated = false;
    bool isLoading = true;

    // Auth Models
    private UserVM _logedUser;
    private double _logesUserHours = 0;
    private ICollection<RoleVM> _loggedUserRoles = new List<RoleVM>();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        if(firstRender)
        {
            _runInTeams = await MicrosoftTeams.IsInTeams();
            await _getLogedUser(_runInTeams);
            isLoading = false;
            StateHasChanged();            
        }
    }

    private async Task _getLogedUser(bool _runInTeams = true)
    {
        try
        {
            // TODO: Get Teams Logged User And Mach him With Our Users
            var teamsUser = await teamsUserCredential.GetUserInfoAsync();
            var userExists = DataProvider.Users.Exists(teamsUser.PreferredUserName);


            string roleName = "Designer"; // Engineer Designer
            var defaultRoleId = await GetRoleId(roleName);
            if (defaultRoleId == 0)
                throw new Exception($"Exception `{roleName}` role not exists!");

            var users = await DataProvider.Roles.GetUsers(defaultRoleId);
            var dbUser = users.FirstOrDefault();

            if (dbUser == null)
                throw new NullReferenceException(nameof(dbUser));

            _logedUser = Mapper.Map<UserVM>(dbUser);

            _logesUserHours = await DataProvider.Users.GetUserHoursFromLastMonday(_logedUser.Id, DateTime.Now);

            _loggedUserRoles = (await DataProvider.Roles.GetEmplyeeRoles(dbUser.Id))
                                                        .Select(r => Mapper.Map<RoleVM>(r))
                                                        .ToList();
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"Exception: {ex.Message}");
            // TODO: Log Error
        }
    }

    private async Task<int> GetRoleId(string roleName)
    {
        try
        {
            var role = await DataProvider.Roles.Get(roleName);
            return role?.Id ?? 0;
        }
        catch (Exception ex)
        {
            // TODO: Log Error
            Debug.WriteLine($"Exception: {ex.Message}");
            return 0;
        }
    }

    private string GetEnvironmentName()
    {
        return HostEnvironment.IsDevelopment() ? "local environment" : "Azure environment";
    }
}
